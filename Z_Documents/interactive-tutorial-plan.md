# インタラクティブチュートリアル実装計画

## 1. 概要

現在のチュートリアルは静的な説明画面のみで、ユーザーが実際の操作を体験できません。本計画では、ユーザーが実際に操作手順を踏めるインタラクティブなチュートリアルを実装します。

## 2. 目標

- ユーザーが実際の画面で操作を体験できる
- 各ステップで正しい操作を促すガイドを表示
- 操作が完了したら次のステップに自動進行
- チュートリアル中は誤操作を防止
- チュートリアル完了後は通常のアプリとして使用可能

## 3. アーキテクチャ設計

### 3.1 コンポーネント構成

```
lib/features/tutorial/
├── interactive_tutorial_screen.dart      # メインのチュートリアル画面
├── providers/
│   └── interactive_tutorial_provider.dart  # チュートリアル状態管理
├── widgets/
│   ├── tutorial_overlay.dart              # オーバーレイ表示用ウィジェット
│   ├── tutorial_spotlight.dart            # スポットライト効果
│   ├── tutorial_tooltip.dart              # ツールチップ表示
│   └── tutorial_step_indicator.dart       # ステップインジケーター
└── models/
    └── tutorial_step.dart                 # チュートリアルステップのモデル
```

### 3.2 技術的アプローチ

**オーバーレイ方式を採用**
- 実際の画面の上に半透明のオーバーレイを表示
- 特定の要素のみをハイライト（スポットライト効果）
- ハイライトされた要素以外はタップ不可にする
- ツールチップで操作手順を説明

**状態管理**
- Riverpodを使用してチュートリアルの進行状態を管理
- 各ステップの完了状態を追跡
- チュートリアル完了フラグをSettingsに保存

## 4. チュートリアルフロー

### 4.1 ステップ1: ホーム画面 - 記録開始ボタン
**目的**: ワークアウト記録の開始方法を理解する

**操作**:
1. ホーム画面にオーバーレイを表示
2. 「記録開始」ボタンをスポットライトでハイライト
3. ツールチップで「このボタンをタップしてワークアウトを開始しましょう」と表示
4. ユーザーがボタンをタップしたら次のステップへ

**実装ポイント**:
- `HomeScreen`にオーバーレイを表示する機能を追加
- ボタンの`GlobalKey`を取得して位置を特定
- ボタンタップを検知して次のステップへ進行

### 4.2 ステップ2: ワークアウト入力画面 - 種目追加
**目的**: 種目の追加方法を理解する

**操作**:
1. ワークアウト入力画面に遷移
2. 空の状態画面で「Add Exercise」ボタンをハイライト
3. ツールチップで「種目を追加しましょう」と表示
4. ユーザーがボタンをタップしたら種目選択モーダルを表示
5. チュートリアル用の推奨種目（例: Bench Press）をハイライト
6. ユーザーが種目を選択したら次のステップへ

**実装ポイント**:
- `WorkoutInputScreen`にオーバーレイ機能を追加
- 種目選択モーダル内でもオーバーレイを表示
- チュートリアル用のダミーデータは使用せず、実際のデータを使用

### 4.3 ステップ3: セット入力 - 重量と回数
**目的**: セットの重量と回数の入力方法を理解する

**操作**:
1. 追加された種目のセット入力欄をハイライト
2. ツールチップで「重量と回数を入力しましょう」と表示
3. ユーザーが重量と回数を入力したら次のステップへ

**実装ポイント**:
- `ExerciseCardWidget`のセット入力欄を特定
- 入力完了を検知（フォーカスアウトまたは値の変更）

### 4.4 ステップ4: 前回記録のコピー機能
**目的**: 前回記録をコピーする機能を理解する

**操作**:
1. 2セット目を追加（または既に存在する場合）
2. 前回記録コピーボタンをハイライト
3. ツールチップで「前回の記録を1タップでコピーできます」と表示
4. ユーザーがコピーボタンをタップしたら次のステップへ

**実装ポイント**:
- チュートリアル用に前回記録のダミーデータを事前に作成
- コピーボタンのタップを検知

### 4.5 ステップ5: タイマー機能
**目的**: タイマー機能の使い方を理解する

**操作**:
1. AppBarのタイマーアイコンボタンをハイライト
2. ツールチップで「セット間の休憩時間を管理できます」と表示
3. ユーザーがタイマーボタンをタップしたらタイマー画面を表示
4. タイマーの基本的な操作を説明（開始・停止・リセット）
5. タイマー画面を閉じたら次のステップへ

**実装ポイント**:
- タイマー画面でもオーバーレイを表示可能にする
- タイマーの操作は任意（スキップ可能）

### 4.6 ステップ6: ワークアウト完了
**目的**: ワークアウトの完了方法を理解する

**操作**:
1. 画面下部の「Complete」ボタンをハイライト
2. ツールチップで「ワークアウトを完了しましょう」と表示
3. ユーザーがボタンをタップしたら確認ダイアログを表示
4. 確認後、ワークアウトを完了
5. ホーム画面に戻り、チュートリアル完了メッセージを表示

**実装ポイント**:
- チュートリアル用のワークアウトセッションは完了後に削除するか、特別なマークを付ける
- チュートリアル完了フラグをSettingsに保存

## 5. 実装詳細

### 5.1 オーバーレイシステム

**TutorialOverlay Widget**
```dart
class TutorialOverlay extends StatelessWidget {
  final Widget child;
  final List<GlobalKey> highlightKeys;
  final String? tooltipText;
  final VoidCallback? onNext;
  final bool isActive;
  
  // 半透明のオーバーレイを表示
  // highlightKeysで指定された要素のみをハイライト
  // ハイライトされた要素以外はタップ不可
}
```

**機能**:
- 半透明の黒いオーバーレイを表示
- 指定された要素の位置を計算してスポットライト効果を適用
- ツールチップを表示
- ハイライトされていない要素へのタップをブロック

### 5.2 スポットライト効果

**TutorialSpotlight Widget**
```dart
class TutorialSpotlight extends CustomPainter {
  final Rect targetRect;
  final double borderRadius;
  
  // CustomPainterを使用してスポットライト効果を描画
  // ターゲット要素の周りに穴を開ける
}
```

### 5.3 状態管理

**InteractiveTutorialProvider**
```dart
class InteractiveTutorialNotifier extends StateNotifier<InteractiveTutorialState> {
  // 現在のステップ
  // 完了したステップのリスト
  // チュートリアル全体の完了状態
  // ステップ進行メソッド
  // ステップスキップメソッド
}
```

### 5.4 データベース拡張

**Settings Entity に追加**
- `tutorial_completed`: チュートリアル完了フラグ（既存の`setup_completed`とは別）

**Settings DAO に追加**
- `markTutorialCompleted()`: チュートリアル完了をマーク
- `isTutorialCompleted()`: チュートリアル完了状態を取得

## 6. 実装手順

### Phase 1: 基盤構築
1. チュートリアルモデルとプロバイダーの作成
2. オーバーレイウィジェットの実装
3. スポットライト効果の実装
4. ツールチップウィジェットの実装

### Phase 2: ステップ実装
1. ステップ1: ホーム画面の記録開始ボタン
2. ステップ2: 種目追加
3. ステップ3: セット入力
4. ステップ4: 前回記録コピー
5. ステップ5: タイマー機能
6. ステップ6: ワークアウト完了

### Phase 3: 統合とテスト
1. 各画面への統合
2. チュートリアル完了状態の保存
3. チュートリアル再表示機能（設定画面から）
4. エラーハンドリング
5. 多言語対応

## 7. 考慮事項

### 7.1 ユーザビリティ
- 各ステップで「スキップ」ボタンを提供
- チュートリアル中は誤操作を防止
- 視覚的なフィードバック（アニメーション、ハイライト）
- 進捗インジケーターを表示

### 7.2 パフォーマンス
- オーバーレイの再描画を最小限に
- 位置計算の最適化
- メモリリークの防止

### 7.3 エッジケース
- 画面サイズの違いへの対応
- キーボード表示時のレイアウト調整
- 画面回転時の対応
- アプリバックグラウンド時の状態保持

### 7.4 データ管理
- チュートリアル用のワークアウトデータの扱い
- チュートリアル完了後のデータクリーンアップ
- チュートリアル再実行時のデータリセット

## 8. 依存パッケージ

既存のパッケージで実装可能ですが、必要に応じて以下を検討：
- `flutter_tutorial_coach_mark`: 既存のチュートリアルライブラリ（参考用）
- カスタム実装を推奨（アプリの要件に完全に合わせられるため）

## 9. テスト計画

### 9.1 ユニットテスト
- チュートリアルプロバイダーのテスト
- ステップ進行ロジックのテスト

### 9.2 ウィジェットテスト
- オーバーレイウィジェットのテスト
- スポットライト効果のテスト
- ツールチップのテスト

### 9.3 統合テスト
- チュートリアルフロー全体のテスト
- 各画面での動作確認

## 10. 今後の拡張

- チュートリアルのカスタマイズ（ユーザーが特定の機能だけを再学習）
- 高度な機能のチュートリアル（進捗グラフ、履歴検索など）
- アニメーションガイド（操作のデモンストレーション）

## 11. Overlay/OverlayEntry 方式（座標ずれ解消）

### 11.1 問題点（旧実装）
- ターゲットのグローバル座標を取得し、親Stackのローカル座標に変換していた
- 親Stackの位置に依存するため、SafeAreaの有無や画面ごとの違いでずれが発生
- 言語によるテキスト長・ボタンサイズの違いでレイアウトタイミングが変わり、ずれの原因に

### 11.2 ベストプラクティス（採用済み）
- **Overlay/OverlayEntry** を使用し、画面全体に直接描画
- **座標変換不要**: Overlayは画面座標系で動作するため、`localToGlobal` で得た座標をそのまま使用
- **一貫した動作**: 親ウィジェットの構造（SafeAreaの有無など）に依存しない
- 参考: [Creating Spotlight Tutorials in Flutter - DEV Community](https://dev.to), Flutter Overlay Widget Guide

### 11.3 実装の要点
- `TutorialOverlay` は `Overlay.of(context).insert(OverlayEntry(...))` でオーバーレイを挿入
- ターゲットの `Rect` は `RenderBox.localToGlobal(Offset.zero)` + `size` で取得（画面座標）
- スポットライト・ツールチップはその Rect をそのまま使用（変換なし）
- ウィジェットの `build` は `SizedBox.shrink()` を返す（描画は OverlayEntry 内で行う）

## 12. 実装優先順位

**P0 (必須)**:
- オーバーレイシステム
- ステップ1-3（基本的なワークアウト記録フロー）
- チュートリアル完了状態の保存

**P1 (重要)**:
- ステップ4-5（前回記録コピー、タイマー）
- エラーハンドリング
- 多言語対応

**P2 (任意)**:
- チュートリアル再表示機能
- アニメーション強化
- カスタマイズ機能
