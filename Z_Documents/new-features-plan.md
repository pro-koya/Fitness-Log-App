# 新機能実装計画

## 概要

以下の3つの新機能を実装します：

1. **トレーニング記録の日時編集機能** - 開始日時・終了日時を後から編集可能に
2. **種目ごとのメモ機能** - トレーニングで気をつけたことを記録
3. **種目の部位情報** - 将来的なボリューム分析や絞り込み検索のため

---

## 機能1: トレーニング記録の日時編集機能

### 目的
スマホを忘れた時など、後から入力したい場合に備えるため

### データベース設計
- **既存テーブル**: `workout_session`
- **既存カラム**: `startTime`, `endTime` (DATETIME型)
- **変更**: 不要（既存の構造で対応可能）

### UI/UX設計

#### 編集場所
**オプション1: トレーニング詳細画面（WorkoutDetailScreen）に編集ボタンを追加**
- 推奨案
- 日時情報が既に表示されている場所で編集できる
- 編集アイコン（鉛筆アイコン）をタップ → 編集モーダル表示

#### 編集UIデザイン
```
┌─────────────────────────────┐
│ 日時編集                      │
├─────────────────────────────┤
│                             │
│ 開始日時                     │
│ ┌─────────────────────────┐ │
│ │ 2024/01/07  14:30      ▼│ │
│ └─────────────────────────┘ │
│                             │
│ 終了日時                     │
│ ┌─────────────────────────┐ │
│ │ 2024/01/07  15:45      ▼│ │
│ └─────────────────────────┘ │
│                             │
│  ⚠️ 開始日時は終了日時より前  │
│     である必要があります      │
│                             │
│ [キャンセル]  [保存]          │
└─────────────────────────────┘
```

#### バリデーション
1. 開始日時 < 終了日時
2. 未来の日時は不可
3. 空欄不可

#### 実装ステップ
1. WorkoutDetailScreenに編集ボタンを追加
2. 日時編集モーダルウィジェットを作成
3. `WorkoutSessionNotifier`に更新メソッドを追加
4. バリデーション実装
5. 成功/エラーメッセージ表示

---

## 機能2: 種目ごとのメモ機能

### 目的
トレーニングで気をつけたことを記録するため

### データベース設計

#### テーブル: `workout_exercise`
**新規カラム追加**:
```sql
ALTER TABLE workout_exercise ADD COLUMN memo TEXT;
```

- `memo`: TEXT型（NULL許可）
- 種目ごとに1つのメモを保存

### UI/UX設計

#### 入力場所
**トレーニング記録中（WorkoutInputScreen）の各種目カード内**

#### UIデザイン案

**折りたたみ式（推奨）**:
```
┌────────────────────────────────┐
│ Bench Press                    │
│ ┌──────────┬──────┬──────┐    │
│ │ Set 1    │ 60kg │ 10reps│   │
│ └──────────┴──────┴──────┘    │
│                                │
│ 📝 メモ ▼                       │  ← クリックで展開
└────────────────────────────────┘

展開時:
┌────────────────────────────────┐
│ 📝 メモ ▲                       │
│ ┌──────────────────────────┐   │
│ │フォームに注意。            │   │
│ │肩甲骨を寄せて...          │   │
│ └──────────────────────────┘   │
└────────────────────────────────┘
```

#### 表示場所
- **トレーニング記録中**: 種目カード内（折りたたみ式）
- **トレーニング詳細**: 種目ごとに表示
- **履歴**: 種目ごとに表示

#### 実装ステップ
1. データベースマイグレーション（memoカラム追加）
2. `WorkoutExerciseEntity`に`memo`フィールド追加
3. `WorkoutExerciseModel`に`memo`フィールド追加
4. DAO層でmemoの読み書き実装
5. `ExerciseCardWidget`にメモ入力UIを追加
   - 折りたたみ可能なTextField
   - 文字数制限（例: 500文字）
6. 保存処理の実装
7. 詳細画面・履歴画面でメモを表示

---

## 機能3: トレーニング種目の部位情報

### 目的
将来的に部位ごとのボリューム分析や、種目選択時の絞り込みを可能にするため

### データベース設計

#### 部位マスタデータ
**推奨される部位リスト**:
1. 胸（Chest）
2. 背中（Back）
3. 脚（Legs）
4. 肩（Shoulders）
5. 上腕二頭筋（Biceps）
6. 上腕三頭筋（Triceps）
7. 腹筋（Abs）
8. その他（Other）

#### オプション1: シンプル版（単一部位）
```sql
ALTER TABLE exercise_master ADD COLUMN body_part TEXT;
```

#### オプション2: 複合版（複数部位対応）
新しいテーブルを作成:
```sql
CREATE TABLE body_part_master (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  name_en TEXT NOT NULL,
  display_order INTEGER
);

CREATE TABLE exercise_body_part (
  exercise_id INTEGER NOT NULL,
  body_part_id INTEGER NOT NULL,
  is_primary INTEGER DEFAULT 1,  -- 主要部位か補助部位か
  PRIMARY KEY (exercise_id, body_part_id),
  FOREIGN KEY (exercise_id) REFERENCES exercise_master(id),
  FOREIGN KEY (body_part_id) REFERENCES body_part_master(id)
);
```

**推奨**: まずはオプション1（シンプル版）で実装し、将来的に必要になったらオプション2に移行

### UI/UX設計

#### 1. 種目マスタでの部位設定

**カスタム種目作成時**:
```
┌─────────────────────────────┐
│ カスタム種目作成              │
├─────────────────────────────┤
│ 種目名                       │
│ ┌─────────────────────────┐ │
│ │ Cable Fly               │ │
│ └─────────────────────────┘ │
│                             │
│ 部位 *                       │
│ ┌─────────────────────────┐ │
│ │ 胸                     ▼│ │  ← ドロップダウン
│ └─────────────────────────┘ │
│                             │
│         [キャンセル] [作成]   │
└─────────────────────────────┘
```

#### 2. 種目選択画面での絞り込み

**ExerciseSelectorModal更新**:
```
┌──────────────────────────────┐
│ 種目を選択                     │
├──────────────────────────────┤
│ [全て] [胸] [背中] [脚] [肩]   │  ← タブまたはチップ
│ [二頭筋] [三頭筋] [腹筋]       │
│ [その他]                      │
├──────────────────────────────┤
│ 🔍 検索...                    │
├──────────────────────────────┤
│ 💪 胸                         │
│   Bench Press                │
│   Incline Bench Press        │
│   Dumbbell Fly               │
│                              │
│ 💪 背中                       │
│   Deadlift                   │
│   ...                        │
└──────────────────────────────┘
```

#### 3. 種目表示時の部位アイコン

```
┌────────────────────────────────┐
│ 💪 Bench Press (胸)            │  ← 部位ラベル
│ ┌──────────┬──────┬──────┐    │
│ │ Set 1    │ 60kg │ 10reps│   │
│ └──────────┴──────┴──────┘    │
└────────────────────────────────┘
```

#### 部位の多言語対応
```dart
class BodyPartLocalization {
  static const Map<String, Map<String, String>> bodyParts = {
    'chest': {'en': 'Chest', 'ja': '胸'},
    'back': {'en': 'Back', 'ja': '背中'},
    'legs': {'en': 'Legs', 'ja': '脚'},
    'shoulders': {'en': 'Shoulders', 'ja': '肩'},
    'biceps': {'en': 'Biceps', 'ja': '上腕二頭筋'},
    'triceps': {'en': 'Triceps', 'ja': '上腕三頭筋'},
    'abs': {'en': 'Abs', 'ja': '腹筋'},
    'other': {'en': 'Other', 'ja': 'その他'},
  };
}
```

### 実装ステップ

#### Phase 1: データベース準備
1. `exercise_master`に`body_part`カラム追加
2. マイグレーション実装
3. 既存の標準種目にデフォルト部位を設定

#### Phase 2: データ層
1. `ExerciseMasterEntity`に`bodyPart`追加
2. DAO層で部位の読み書き実装
3. 部位による検索メソッド追加

#### Phase 3: UI実装
1. 部位選択ドロップダウンウィジェット作成
2. カスタム種目作成画面に部位選択を追加
3. `ExerciseSelectorModal`に部位フィルター追加
4. 種目表示時に部位ラベルを表示

---

## 実装順序（優先度順）

### Phase 1: 基盤整備
1. **データベースマイグレーション**
   - `workout_exercise.memo`追加
   - `exercise_master.body_part`追加
   - マイグレーション実行

### Phase 2: メモ機能（最もシンプル）
1. エンティティ・モデル層更新
2. DAO層更新
3. UI実装（ExerciseCardWidgetにメモフィールド追加）
4. テスト

### Phase 3: 部位情報機能
1. 既存種目データに部位を設定
2. 部位ローカライゼーション実装
3. カスタム種目作成に部位選択追加
4. 種目選択画面に絞り込み機能追加
5. 種目表示に部位ラベル追加
6. テスト

### Phase 4: 日時編集機能
1. WorkoutDetailScreenに編集UI追加
2. 日時編集モーダル作成
3. バリデーション実装
4. 更新処理実装
5. テスト

---

## 技術的考慮事項

### データベースマイグレーション
現在のアプリはマイグレーション機構が明示的にないため、以下の対応が必要：

1. **データベースバージョン管理**
   ```dart
   static const int _databaseVersion = 2;  // 1 → 2
   ```

2. **onUpgradeハンドラ実装**
   ```dart
   onUpgrade: (db, oldVersion, newVersion) async {
     if (oldVersion < 2) {
       await db.execute('ALTER TABLE workout_exercise ADD COLUMN memo TEXT');
       await db.execute('ALTER TABLE exercise_master ADD COLUMN body_part TEXT DEFAULT "other"');
     }
   }
   ```

### 既存データへの影響
- **memo**: NULL許可なので既存データに影響なし
- **body_part**: デフォルト値 "other" を設定

### UI/UXの一貫性
- Material Design 3のガイドラインに従う
- 既存のコンポーネントスタイルと統一
- 日本語と英語両方で自然な表現

---

## 想定工数

| フェーズ | 作業内容 | 工数 |
|---------|---------|------|
| Phase 1 | データベースマイグレーション | 1-2時間 |
| Phase 2 | メモ機能実装 | 3-4時間 |
| Phase 3 | 部位情報機能実装 | 4-5時間 |
| Phase 4 | 日時編集機能実装 | 2-3時間 |
| テスト・調整 | 全体テスト・UI調整 | 2-3時間 |
| **合計** | | **12-17時間** |

---

## 次のステップ

1. この計画を確認・承認
2. 懸念点や変更要望があれば調整
3. Phase 1（データベースマイグレーション）から実装開始

計画について質問や変更希望があればお知らせください！
